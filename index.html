<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gramedics - Integrated App with Doctor Finder</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Leaflet & MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    :root{
      --blue-700:#1e40af; --blue-500:#3b82f6; --blue-600:#2563eb; --muted:#4b5563; --card-shadow: rgba(59,130,246,0.18); --danger:#dc2626;
    }
    html,body{height:100%;margin:0;font-family:'Poppins',Arial,sans-serif;background:linear-gradient(to bottom,#dbeafe,#eff6ff);color:var(--blue-700)}
    header{background:var(--blue-700);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 4px 10px rgba(0,0,0,.12)}
    .logo{width:44px;height:44px;fill:#60a5fa}
    h1{margin:0;font-size:1.45rem;font-weight:700}
    .hero{padding:26px 18px;text-align:center;background:rgba(255,255,255,0.92);border-bottom:1px solid #c9d2f3}
    .hero h2{margin:0;color:#1c7ed6}
    .hero p{margin:6px 0 0;color:var(--muted)}
    main{max-width:1200px;margin:18px auto;padding:8px}
    .section-header{font-weight:600;margin:18px 0 8px}
    .features-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .feature-card{background:var(--blue-500);color:white;padding:18px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 6px 18px var(--card-shadow);min-height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;font-weight:600;transition:transform .16s,box-shadow .16s}
    .feature-card i{font-size:1.5rem}
    .feature-card:hover{transform:translateY(-6px);background:var(--blue-600);box-shadow:0 12px 26px rgba(37,99,235,.25)}
    footer{background:#dbeafe;padding:12px;text-align:center;color:var(--muted);margin-top:18px;border-top:1px solid #cbdffd}

    /* popups + fullscreen modals */
    .popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;align-items:center;justify-content:center;padding:12px}
    .popup.is-visible{display:flex}
    .popup-box{background:white;border-radius:12px;padding:18px;max-width:820px;width:100%;box-shadow:0 10px 40px rgba(2,6,23,.25);position:relative}
    .popup-close{position:absolute;right:12px;top:12px;border:none;background:none;font-size:18px;cursor:pointer;color:var(--muted)}

    .fullscreen{display:none;position:fixed;inset:0;z-index:9500;overflow:auto;background:linear-gradient(to bottom,#dbeafe,#eff6ff);padding:18px}
    .fullscreen.is-visible{display:block}
    .fs-header{background:var(--blue-700);color:#fff;padding:12px;border-radius:10px;display:flex;align-items:center;justify-content:space-between}
    .fs-close{background:none;border:none;color:#fff;font-size:18px;cursor:pointer}

    .card{background:white;padding:12px;border-radius:10px;box-shadow:0 6px 18px var(--card-shadow);margin-bottom:12px}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--blue-700);font-size:0.92rem}
    input,select,textarea,button{font-family:inherit;padding:8px 10px;border-radius:8px;border:1px solid #d1d9e6;width:100%;box-sizing:border-box}
    button{background:var(--blue-500);color:#fff;border:none;cursor:pointer}
    button.muted{background:#dbeafe;color:var(--blue-700)}
    .muted{background:#dbeafe;color:var(--blue-700)}

    .list-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f8fbff;margin-bottom:8px}
    .small-muted{color:var(--muted);font-size:0.9rem}
    .status{font-weight:700;padding:6px 10px;border-radius:8px;font-size:0.9rem;display:inline-block}
    .status.up-to-date{background:#bbf7d0;color:#165f3b}
    .status.overdue{background:#fecaca;color:#7f1d1d}
    .status.upcoming{background:#fed7aa;color:#92400e}
    .status.not-started{background:#e5e7eb;color:#374151}

    .col-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){ .col-2{grid-template-columns:1fr} .feature-card{min-height:120px} }

    /* Doctor Finder specific */
    #doctorFinder .finder-container{display:flex;gap:12px;height:calc(100vh - 200px)}
    #doctorFinder .finder-map{flex:1;border-radius:10px;overflow:hidden;position:relative}
    #doctorFinder .finder-sidebar{width:360px;max-width:40%;min-width:280px;overflow:auto}
    #doctorFinder .sidebar-card{padding:12px;border-radius:10px;background:white;box-shadow:0 6px 18px var(--card-shadow);margin-bottom:10px}
    #doctorFinder .facility-item{padding:10px;border-radius:10px;background:#fff;border:1px solid #eef6ff;margin-bottom:8px;cursor:pointer}
    #doctorFinder .facility-item.active{outline:3px solid rgba(59,130,246,0.15);box-shadow:0 8px 18px rgba(59,130,246,0.06)}
    #doctorFinder .facility-type{font-size:0.85rem;padding:4px 8px;border-radius:8px;background:#f1f9ff;color:var(--blue-700);font-weight:700}
    #doctorFinder .search-history{display:flex;gap:8px;align-items:center;margin-top:8px}

    /* map spinner overlay (universal) */
    .spinner-overlay{display:none;position:absolute;inset:0;background:rgba(3,7,18,0.35);z-index:999;align-items:center;justify-content:center}
    .spinner-overlay.is-visible{display:flex}
    .spinner-ring{width:84px;height:84px;border-radius:50%;border:6px solid rgba(255,255,255,0.2);border-top-color:var(--blue-500);animation:spin 1s linear infinite;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* highlighted marker pulse in sidebar */
    .highlight-pulse{box-shadow:0 0 0 6px rgba(59,130,246,0.08)}
  </style>
</head>
<body>
  <header>
    <svg class="logo" viewBox="0 0 24 24"><path d="M1 12h4l3 8 4-16 3 12 3-6h4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
    <h1>Gramedics</h1>
  </header>

  <div class="hero">
    <h2>Connecting Villages to Care</h2>
    <p class="small-muted">Trackers, services and a Doctor Finder — now with AI chatbot support.</p>
  </div>

  <main>
    <div>
      <div class="section-header">Everyday Health & Management</div>
      <div class="features-grid">
        <div class="feature-card" id="card-symptoms"><i class="fas fa-notes-medical"></i>Symptoms Diagnosis</div>
        <div class="feature-card" id="card-stats"><i class="fas fa-chart-line"></i>Health Statistics</div>
        <div class="feature-card" id="card-family"><i class="fas fa-users"></i>Family Health Records</div>
        <div class="feature-card" id="card-nutrition"><i class="fas fa-apple-alt"></i>Nutrition & Hygiene Tips</div>
      </div>
    </div>

    <div style="margin-top:18px">
      <div class="section-header">Trackers</div>
      <div class="features-grid">
        <div class="feature-card" id="open-vaccination"><i class="fas fa-syringe"></i>Vaccination Tracking</div>
        <div class="feature-card" id="open-tracker"><i class="fas fa-pills"></i>Medicine Tracker</div>
      </div>
    </div>

    <div style="margin-top:18px">
      <div class="section-header">Services</div>
      <div class="features-grid">
        <div class="feature-card" id="card-doctors"><i class="fas fa-hospital"></i>Find Nearby Doctors</div>
        <div class="feature-card" id="open-sos"><i class="fas fa-phone-alt"></i>Emergency SOS</div>
        <div class="feature-card" id="card-drives"><i class="fas fa-bell"></i>Medical Drive Notifications</div>
        <div class="feature-card" id="card-chatbot"><i class="fas fa-robot"></i>Chat Bot for Queries</div>
      </div>
    </div>
  </main>

  <footer>&copy; 2025 Gramedics - Empowering Rural Healthcare</footer>

  <!-- ---------------- small popups / fullscreen placeholders (Symptoms, Nutrition etc) ---------------- -->
  <div id="symptomPopup" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-symptom">&times;</button>
      <h3>Symptoms Diagnosis</h3>
      <p class="small-muted">Enter symptoms (comma separated). This is a helper — not a diagnosis.</p>
      <div class="card">
        <label>Symptoms</label>
        <input id="symptoms-input" placeholder="fever, cough, sore throat">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="symptoms-analyze">Analyze</button>
          <button class="muted" id="symptoms-clear">Clear</button>
        </div>
      </div>
      <div class="card">
        <h4>Suggestions</h4>
        <div id="symptom-results" class="small-muted">No analysis yet.</div>
      </div>
    </div>
  </div>

  <div id="nutritionPopup" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-nutrition">&times;</button>
      <h3>Nutrition & Hygiene Tips</h3>
      <div class="card">
        <div style="display:flex;gap:8px">
          <input id="new-tip" placeholder="Add a tip">
          <button class="muted" id="add-tip">Add</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="muted" id="random-tip">Show Random Tip</button>
          <button class="muted" id="list-tips">List All Tips</button>
        </div>
      </div>
      <div class="card">
        <h4>Tip</h4>
        <div id="tip-display" class="small-muted">No tip yet.</div>
        <div id="tips-list" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- Chatbot popup (AI integrated) -->
  <div id="chatPopup" class="popup" aria-hidden="true">
    <div class="popup-box" style="max-width:820px">
      <button class="popup-close" id="close-chat">&times;</button>
      <h3>Chat Bot for Queries</h3>
      <p class="small-muted">AI-powered responses via OpenAI if you provide an API key (stored locally). Falls back to basic help if no key.</p>

      <div class="card" style="margin-bottom:10px;">
        <label>OpenAI API Key (paste here to enable AI)</label>
        <div style="display:flex;gap:8px">
          <input id="chat-api-key" placeholder="sk-... (keep private)" type="password" style="flex:1">
          <button id="chat-save-key" class="muted">Save Key</button>
          <button id="chat-clear-key" class="muted">Clear Key</button>
        </div>
        <small class="small-muted">Key is stored in your browser only.</small>
      </div>

      <div class="card" id="chat-history" style="height:300px;overflow:auto"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chat-input" placeholder="Ask a health question...">
        <button id="chat-send">Send</button>
      </div>
      <div style="margin-top:8px"><button id="chat-clear" class="muted">Clear History</button></div>
    </div>
  </div>

  <!-- SOS popup -->
  <div id="sosModal" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-sos">&times;</button>
      <h3 style="color:var(--danger)">Emergency SOS</h3>
      <p class="small-muted">Press SOS to call emergency services (108).</p>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button class="sos-btn" id="sos-btn">SOS</button>
      </div>
    </div>
  </div>

  <!-- Trackers & other fullscreens (placeholders kept minimal, trackers from earlier can be re-added) -->
  <!-- Medicine & Vaccination fullscreens omitted here for brevity (they were in earlier file). If needed, they can be re-integrated. -->

  <!-- ---------------- DOCTOR FINDER FULLSCREEN MODAL ---------------- -->
  <div id="doctorFinder" class="fullscreen" aria-hidden="true">
    <div class="fs-header">
      <h3>Find Nearby Medical Facilities</h3>
      <div>
        <button class="muted" id="df-clear-history">Clear History</button>
        <button class="fs-close" id="df-close">&times;</button>
      </div>
    </div>

    <div style="max-width:1200px;margin:14px auto;">
      <div class="card sidebar-card" style="margin-bottom:10px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label>Location (manual)</label>
            <input id="df-location" placeholder="Enter town, village or address">
          </div>
          <div style="width:160px">
            <label>&nbsp;</label>
            <div style="display:flex;gap:8px">
              <button id="df-search">Search</button>
              <button id="df-reset" class="muted">Reset</button>
            </div>
          </div>
        </div>

        <div class="search-history" style="margin-top:10px">
          <select id="df-history-select" style="flex:1">
            <option value="">— Recent searches —</option>
          </select>
          <button id="df-use-history" class="muted">Use</button>
        </div>
      </div>

      <div id="df-content" style="display:flex;gap:12px" class="finder-container">
        <div class="finder-map card" id="df-map-wrap" style="position:relative">
          <!-- map will be injected here -->
          <div id="df-map" style="width:100%;height:100%"></div>
          <div id="df-spinner" class="spinner-overlay"><div class="spinner-ring">Searching...</div></div>
        </div>

        <div class="finder-sidebar">
          <div class="sidebar-card">
            <h4 style="margin:0 0 8px">Facilities</h4>
            <div id="df-results" style="max-height:calc(100vh - 260px);overflow:auto"></div>
          </div>
          <div class="sidebar-card">
            <h4 style="margin:0 0 8px">Legend</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="facility-type" style="background:#fee2e2;color:#991b1b">Hospital</div>
              <div class="facility-type" style="background:#eef2ff;color:#1e3a8a">Doctor / Clinic</div>
              <div class="facility-type" style="background:#d1fae5;color:#065f46">Pharmacy</div>
            </div>
            <p class="small-muted" style="margin-top:10px">Click a facility to zoom the map. Click markers to highlight the list.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet & MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  /* ---------------- Helpers ---------------- */
  const $ = id => document.getElementById(id);
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function openPopup(el){ el.classList.add('is-visible'); el.setAttribute('aria-hidden','false'); }
  function closePopup(el){ el.classList.remove('is-visible'); el.setAttribute('aria-hidden','true'); }

  // Generic ESC close
  window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.popup.is-visible, .fullscreen.is-visible').forEach(x=>x.classList.remove('is-visible')); } });

  /* ---------------- Basic UI wiring (cards) ---------------- */
  // Simple placeholders for other cards:
  $('card-symptoms').addEventListener('click', ()=> openPopup($('symptomPopup')));
  $('close-symptom').addEventListener('click', ()=> closePopup($('symptomPopup')));
  $('card-nutrition').addEventListener('click', ()=> openPopup($('nutritionPopup')));
  $('close-nutrition').addEventListener('click', ()=> closePopup($('nutritionPopup')));

  // Chatbot wiring (basic)
  $('card-chatbot').addEventListener('click', ()=> openPopup($('chatPopup')));
  $('close-chat').addEventListener('click', ()=> closePopup($('chatPopup')));

  // SOS wiring
  $('open-sos').addEventListener('click', ()=> openPopup($('sosModal')));
  $('close-sos').addEventListener('click', ()=> closePopup($('sosModal')));
  $('sos-btn').addEventListener('click', ()=> { if(confirm('Call emergency number 108 now?')) window.location.href = 'tel:108'; });

  /* ---------------- Nutrition tips logic ---------------- */
  const TIP_KEY = 'grams_tips_v1'; let tips = [];
  function tipsLoad(){ try{ tips = JSON.parse(localStorage.getItem(TIP_KEY) || '[]'); }catch(e){ tips=[]; } }
  function tipsSave(){ localStorage.setItem(TIP_KEY, JSON.stringify(tips)); }
  tipsLoad(); if(tips.length===0){ tips=['Eat fruits and vegetables daily.','Wash hands before meals and after toilet.','Drink safe water.','Include protein sources in diet.','Keep food covered.']; tipsSave(); }
  $('add-tip').addEventListener('click', ()=> { const t=$('new-tip').value.trim(); if(!t) return alert('Enter a tip'); tips.push(t); tipsSave(); $('new-tip').value=''; alert('Tip added'); });
  $('random-tip').addEventListener('click', ()=> { tipsLoad(); $('tip-display').textContent = tips.length ? tips[Math.floor(Math.random()*tips.length)] : 'No tips.'; });
  $('list-tips').addEventListener('click', ()=> { tipsLoad(); $('tips-list').innerHTML = tips.map((t,i)=>`<div class="list-row">${escapeHtml(t)} <button class="muted" data-i="${i}" onclick="deleteTip(event)">Delete</button></div>`).join('') || '<p class="small-muted">No tips</p>'; });
  window.deleteTip = function(ev){ const i=Number(ev.target.getAttribute('data-i')); if(!isFinite(i)) return; if(!confirm('Delete tip?')) return; tips.splice(i,1); tipsSave(); $('list-tips').click(); };

  /* ---------------- Doctor Finder Implementation ---------------- */

  // Elements
  const DF = { modal: $('doctorFinder'), mapWrap: $('df-map-wrap'), mapEl: $('df-map'), resultsEl: $('df-results'), spinner: $('df-spinner'), locInput: $('df-location'), btnSearch: $('df-search'), btnReset: $('df-reset'), historySelect: $('df-history-select'), btnUseHistory: $('df-use-history'), clearHistoryBtn: $('df-clear-history'), dfClose: $('df-close') };

  // History storage
  const DF_HISTORY_KEY = 'df_history_v1';
  function dfLoadHistory(){ try{ return JSON.parse(localStorage.getItem(DF_HISTORY_KEY) || '[]'); }catch(e){ return []; } }
  function dfSaveHistory(arr){ localStorage.setItem(DF_HISTORY_KEY, JSON.stringify(arr)); }
  function dfAddToHistory(q){
    if(!q) return;
    let arr = dfLoadHistory();
    arr = arr.filter(x => x !== q);
    arr.unshift(q);
    if(arr.length>5) arr = arr.slice(0,5);
    dfSaveHistory(arr);
    dfRenderHistory();
  }
  function dfRenderHistory(){
    const arr = dfLoadHistory();
    DF.historySelect.innerHTML = `<option value="">— Recent searches —</option>` + arr.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  }
  DF.clearHistoryBtn = $('df-clear-history');
  DF.clearHistoryBtn.addEventListener('click', ()=>{ if(confirm('Clear search history?')){ dfSaveHistory([]); dfRenderHistory(); } });

  // Spinner helpers
  function showSpinner(){ DF.spinner.classList.add('is-visible'); }
  function hideSpinner(){ DF.spinner.classList.remove('is-visible'); }

  // Map initialization
  let map, markersLayer, markers = [], clusterGroup;
  function createSvgIcon(color){
    const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40"><path d="M16 0C9 0 4 6 4 11c0 8 12 22 12 22s12-14 12-22c0-5-5-11-12-11z" fill="${color}"/></svg>`);
    return L.icon({ iconUrl: `data:image/svg+xml;charset=utf-8,${svg}`, iconSize:[32,40], iconAnchor:[16,40], popupAnchor:[0,-36] });
  }
  const ICONS = {
    hospital: createSvgIcon('#ef4444'), // red
    clinic: createSvgIcon('#2563eb'), // blue
    pharmacy: createSvgIcon('#16a34a') // green
  };

  function initMapIfNeeded(){
    if(map) return;
    map = L.map('df-map', { zoomControl:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
    clusterGroup = L.markerClusterGroup();
    markersLayer = L.layerGroup().addTo(map);
    clusterGroup.addTo(map);
    // set default view
    map.setView([20.5937,78.9629], 5); // India-centered default
    // handle marker click highlight
  }

  function clearMarkers(){
    markers = [];
    clusterGroup.clearLayers();
    markersLayer.clearLayers();
    DF.resultsEl.innerHTML = '<p class="small-muted">No results yet.</p>';
  }

  function highlightListItem(id){
    // remove active from others
    document.querySelectorAll('#df-results .facility-item').forEach(el=> el.classList.remove('active'));
    const el = document.querySelector(`#df-results .facility-item[data-id="${id}"]`);
    if(el){
      el.classList.add('active');
      el.scrollIntoView({behavior:'smooth',block:'nearest'});
    }
  }

  function addFacilityToSidebar(f, id){
    const phone = f.tags.phone || f.tags['contact:phone'] || '';
    const web = f.tags.website || f.tags.url || '';
    const hours = f.tags.opening_hours || '';
    const addr = [
      f.tags['addr:street']||'', f.tags['addr:city']||'', f.tags['addr:postcode']||'', f.tags['addr:country']||''
    ].filter(Boolean).join(', ');
    const typeLabel = (f.tags.amenity === 'hospital') ? 'Hospital' : ((f.tags.amenity === 'pharmacy') ? 'Pharmacy' : 'Clinic/Doctor');
    const html = `
      <div class="facility-item" data-id="${id}">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(f.tags.name || f.tags.operator || 'Unnamed')}</div>
            <div class="small-muted" style="margin-top:6px">${escapeHtml(typeLabel)} • ${escapeHtml(addr || (f.tags.name ? '' : 'No address'))}</div>
            <div style="margin-top:6px" class="small-muted">${phone ? '📞 ' + escapeHtml(phone) : ''} ${web ? ' • 🔗 ' + `<a href="${escapeHtml(web)}" target="_blank" rel="noreferrer">${escapeHtml(web)}</a>` : ''}</div>
            <div style="margin-top:6px" class="small-muted">${hours ? '⏰ ' + escapeHtml(hours) : ''}</div>
          </div>
        </div>
      </div>
    `;
    DF.resultsEl.insertAdjacentHTML('beforeend', html);
    // bind click
    const newEl = DF.resultsEl.querySelector(`.facility-item[data-id="${id}"]`);
    newEl.addEventListener('click', ()=>{
      const mobj = markers.find(m => m.id === id);
      if(mobj && map){
        map.setView(mobj.latlng, 17, { animate:true });
        mobj.marker.openPopup();
        highlightListItem(id);
      }
    });
  }

  function buildOverpassQuery(lat, lon, radius=2000){
    // search for amenities doctor|clinic|hospital|pharmacy within radius meters
    // prefer nodes and ways
    return `[out:json][timeout:25];
      (
        node(around:${radius},${lat},${lon})[amenity~"^(doctor|clinic|hospital|pharmacy)$"];
        way(around:${radius},${lat},${lon})[amenity~"^(doctor|clinic|hospital|pharmacy)$"];
        relation(around:${radius},${lat},${lon})[amenity~"^(doctor|clinic|hospital|pharmacy)$"];
      );
      out center;`;
  }

  async function geocode(q){
    // Nominatim search (object)
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if(!res.ok) throw new Error('Geocode failed: ' + res.status);
    const data = await res.json();
    return data[0] ? { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display_name: data[0].display_name } : null;
  }

  async function runOverpass(lat, lon, radius){
    const query = buildOverpassQuery(lat, lon, radius);
    const url = 'https://overpass-api.de/api/interpreter';
    const res = await fetch(url, { method:'POST', body: query, headers:{ 'Content-Type':'text/plain' } });
    if(!res.ok) throw new Error('Overpass error: ' + res.status);
    const data = await res.json();
    // normalize elements to nodes with lat/lon
    const elements = data.elements.map(el=>{
      if(el.type === 'node') return el;
      if(el.type === 'way' || el.type === 'relation') {
        // use center if provided
        const lat = el.center?.lat || el.lat || el.bounds?.minlat || null;
        const lon = el.center?.lon || el.lon || el.bounds?.minlon || null;
        return Object.assign({}, el, { lat, lon });
      }
      return el;
    }).filter(e=>e.lat && e.lon);
    return elements;
  }

  // Map marker creation & add to cluster
  function placeFacilitiesOnMap(elements){
    clearMarkers();
    elements.forEach((el)=>{
      const amen = (el.tags && el.tags.amenity) || 'clinic';
      let icon = ICONS.clinic;
      if(amen === 'hospital') icon = ICONS.hospital;
      else if(amen === 'pharmacy') icon = ICONS.pharmacy;
      const latlng = L.latLng(el.lat, el.lon);
      const popupHtml = `<div style="min-width:180px"><strong>${escapeHtml(el.tags.name || el.tags.operator || 'Unnamed')}</strong><div class="small-muted">${escapeHtml(amen)}</div><div style="margin-top:6px" class="small-muted">${escapeHtml(el.tags['addr:street']||'')}${el.tags['addr:city']?(', '+escapeHtml(el.tags['addr:city'])):''}</div>${el.tags.phone?('<div style="margin-top:6px">📞 '+escapeHtml(el.tags.phone)+'</div>'):''}${el.tags.website?('<div style="margin-top:6px">🔗 <a href="'+escapeHtml(el.tags.website)+'" target="_blank" rel="noreferrer">'+escapeHtml(el.tags.website)+'</a></div>'):''}</div>`;
      const marker = L.marker(latlng, { icon }).bindPopup(popupHtml);
      const id = uid('fac');
      clusterGroup.addLayer(marker);
      markers.push({ id, marker, latlng, data: el });
      // add to sidebar
      addFacilityToSidebar(el, id);
      // marker<->sidebar sync
      marker.on('click', ()=> {
        highlightListItem(id);
      });
    });

    // fit map to markers
    const group = L.featureGroup(markers.map(m=>m.marker));
    if(markers.length) map.fitBounds(group.getBounds().pad(0.2));
    else map.setView([20.5937,78.9629], 6);
  }

  // Search flow
  async function dfSearchFlow(query){
    try{
      showSpinner();
      clearMarkers();
      const geo = await geocode(query);
      if(!geo) { hideSpinner(); alert('Location not found. Try a more specific address or town.'); return; }
      // add to history
      dfAddToHistory(query);
      // center map
      map.setView([geo.lat, geo.lon], 14);
      // run Overpass search with radius 3000m
      const elements = await runOverpass(geo.lat, geo.lon, 3000);
      // place markers
      placeFacilitiesOnMap(elements);
    }catch(err){
      console.error(err);
      alert('Search failed: ' + (err.message || err));
    }finally{ hideSpinner(); }
  }

  // Wire Doctor Finder events
  $('card-doctors').addEventListener('click', ()=>{
    // blank input on open (per requirement)
    DF.locInput.value = '';
    dfRenderHistory();
    openPopup(DF.modal);
    // initialize map lazily
    setTimeout(()=>{ initMapIfNeeded(); map.invalidateSize(); clearMarkers(); }, 250);
    // clear sidebar
    DF.resultsEl.innerHTML = '<p class="small-muted">Enter a location and press Search.</p>';
  });
  DF.dfClose.addEventListener('click', ()=> closePopup(DF.modal));
  DF.btnReset.addEventListener('click', ()=>{ DF.locInput.value = ''; clearMarkers(); map.setView([20.5937,78.9629], 5); DF.resultsEl.innerHTML = '<p class="small-muted">Enter a location and press Search.</p>'; });

  // Search button
  DF.btnSearch.addEventListener('click', ()=> {
    const q = DF.locInput.value.trim();
    if(!q) return alert('Enter a location to search.');
    dfSearchFlow(q);
  });

  // Use history
  DF.btnUseHistory.addEventListener('click', ()=> {
    const val = DF.historySelect.value;
    if(!val) return alert('Choose a history item.');
    DF.locInput.value = val;
  });

  // History select change double-click to use? not needed

  // initialize history on load
  dfRenderHistory();

  /* ---------------- Chatbot: AI integration (local key) ---------------- */
  const CHAT_KEY = 'grams_chat_v2';
  const OPENAI_KEY_STORAGE = 'openai_api_key_v1';
  let chats = JSON.parse(localStorage.getItem(CHAT_KEY) || '[]');
  function chatSave(){ localStorage.setItem(CHAT_KEY, JSON.stringify(chats)); }
  function chatRender(){ $('chat-history').innerHTML = chats.length ? chats.map(m=>`<div style="margin-bottom:8px;"><strong>You:</strong><div class="small-muted">${escapeHtml(m.user)}</div><div style="margin-top:6px;color:#0b5fff"><strong>AI:</strong> ${escapeHtml(m.ai)}</div></div>`).join('') : '<p class="small-muted">No messages yet.</p>'; $('chat-history').scrollTop = $('chat-history').scrollHeight; }
  $('chat-save-key').addEventListener('click', ()=> {
    const val = $('chat-api-key').value.trim();
    if(!val) return alert('Enter your OpenAI API key (sk-...)');
    if(val === '••••••' || val === '******'){ alert('To replace existing key, paste the real key.'); return; }
    localStorage.setItem(OPENAI_KEY_STORAGE, val);
    alert('API key saved locally.');
    $('chat-api-key').value = '••••••';
  });
  $('chat-clear-key').addEventListener('click', ()=> { if(confirm('Remove stored API key?')){ localStorage.removeItem(OPENAI_KEY_STORAGE); $('chat-api-key').value=''; alert('Key removed.'); }});

  function fallbackBot(q){
    const t = q.toLowerCase();
    if(t.includes('fever')) return 'Fever: rest, hydrate, paracetamol as advised. See a doctor if >39°C or breathing difficulty.';
    if(t.includes('covid')) return 'For COVID-like symptoms, isolate and test. Seek care for breathing troubles.';
    if(t.includes('headache')) return 'Mild headache: rest, hydrate. Seek medical care for severe/sudden headache.';
    return 'I can provide general info. Paste your OpenAI API key in settings for AI responses, or consult a clinician for specific advice.';
  }

  async function aiRespond(question){
    const key = localStorage.getItem(OPENAI_KEY_STORAGE);
    if(!key) return fallbackBot(question);
    try{
      const body = { model: "gpt-3.5-turbo", messages: [{ role:"system", content:"You are a cautious, helpful medical assistant. Provide general info and always recommend seeing a doctor for concerning symptoms. Do not create prescriptions." }, { role:"user", content: question }], max_tokens:300, temperature:0.2 };
      const res = await fetch("https://api.openai.com/v1/chat/completions", { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer ' + key }, body: JSON.stringify(body) });
      if(!res.ok){ console.error('AI error', await res.text()); return 'AI service returned an error — falling back to basic help.'; }
      const data = await res.json();
      return data?.choices?.[0]?.message?.content?.trim() || 'No response from AI.';
    }catch(e){ console.error(e); return 'AI request failed — falling back to basic help.'; }
  }

  $('chat-send').addEventListener('click', async ()=> {
    const q = $('chat-input').value.trim(); if(!q) return;
    $('chat-input').value = '';
    chats.push({ user: q, ai: '...' }); chatSave(); chatRender();
    const idx = chats.length - 1;
    const resp = await aiRespond(q);
    chats[idx].ai = resp; chatSave(); chatRender();
  });
  $('chat-clear').addEventListener('click', ()=> { if(confirm('Clear chat history?')){ chats=[]; chatSave(); chatRender(); }});
  chatRender();

  /* ---------------- Utility init when DOM ready ---------------- */
  (function init(){
    // set up basic close buttons
    document.querySelectorAll('.popup-close').forEach(btn=>btn.addEventListener('click', ()=> btn.closest('.popup').classList.remove('is-visible')));
    document.querySelectorAll('.fs-close').forEach(btn=>btn.addEventListener('click', ()=> btn.closest('.fullscreen').classList.remove('is-visible')));
    // default spinner hidden
    hideSpinner();
  })();
  </script>
</body>
</html>

