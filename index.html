<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gramedics - Full App</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    :root{
      --blue-700:#1e40af; --blue-500:#3b82f6; --blue-600:#2563eb; --muted:#475569; --card-shadow: rgba(59,130,246,0.18); --danger:#dc2626;
    }
    html,body{height:100%;margin:0;font-family:'Poppins',Arial,sans-serif;background:linear-gradient(to bottom,#dbeafe,#eff6ff);color:var(--blue-700)}
    header{background:var(--blue-700);color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 4px 10px rgba(0,0,0,.12)}
    .logo{width:44px;height:44px;fill:#60a5fa}
    h1{margin:0;font-size:1.45rem;font-weight:700}
    .hero{padding:26px 18px;text-align:center;background:rgba(255,255,255,0.92);border-bottom:1px solid #c9d2f3}
    .hero h2{margin:0;color:#1c7ed6}
    .hero p{margin:6px 0 0;color:var(--muted)}
    main{max-width:1200px;margin:18px auto;padding:8px}
    .section-header{font-weight:600;margin:18px 0 8px}
    .features-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .feature-card{background:var(--blue-500);color:white;padding:18px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 6px 18px var(--card-shadow);min-height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;font-weight:600;transition:transform .16s,box-shadow .16s}
    .feature-card i{font-size:1.5rem}
    .feature-card:hover{transform:translateY(-6px);background:var(--blue-600);box-shadow:0 12px 26px rgba(37,99,235,.25)}
    footer{background:#dbeafe;padding:12px;text-align:center;color:var(--muted);margin-top:18px;border-top:1px solid #cbdffd}

    /* popups + fullscreen */
    .popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;align-items:center;justify-content:center;padding:12px}
    .popup.is-visible{display:flex}
    .popup-box{background:white;border-radius:12px;padding:18px;max-width:820px;width:100%;box-shadow:0 10px 40px rgba(2,6,23,.25);position:relative}
    .popup-close{position:absolute;right:12px;top:12px;border:none;background:none;font-size:18px;cursor:pointer;color:var(--muted)}

    .fullscreen{display:none;position:fixed;inset:0;z-index:9500;overflow:auto;background:linear-gradient(to bottom,#dbeafe,#eff6ff);padding:18px}
    .fullscreen.is-visible{display:block}
    .fs-header{background:var(--blue-700);color:#fff;padding:12px;border-radius:10px;display:flex;align-items:center;justify-content:space-between}
    .fs-close{background:none;border:none;color:#fff;font-size:18px;cursor:pointer}

    .card{background:white;padding:12px;border-radius:10px;box-shadow:0 6px 18px var(--card-shadow);margin-bottom:12px}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--blue-700);font-size:0.92rem}
    input,select,textarea,button{font-family:inherit;padding:8px 10px;border-radius:8px;border:1px solid #d1d9e6;width:100%;box-sizing:border-box}
    button{background:var(--blue-500);color:#fff;border:none;cursor:pointer}
    button.muted{background:#dbeafe;color:var(--blue-700)}
    .list-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f8fbff;margin-bottom:8px}
    .small-muted{color:var(--muted);font-size:0.9rem}
    .status{font-weight:700;padding:6px 10px;border-radius:8px;font-size:0.9rem;display:inline-block}
    .status.up-to-date{background:#bbf7d0;color:#165f3b}
    .status.overdue{background:#fecaca;color:#7f1d1d}
    .status.upcoming{background:#fed7aa;color:#92400e}
    .status.not-started{background:#e5e7eb;color:#374151}

    .col-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){ .col-2{grid-template-columns:1fr} .feature-card{min-height:120px} }

    /* universal spinner overlay */
    .spinner-overlay{display:none;position:fixed;inset:0;background:rgba(3,7,18,0.35);z-index:11000;align-items:center;justify-content:center}
    .spinner-overlay.is-visible{display:flex}
    .spinner-ring{width:88px;height:88px;border-radius:50%;border:8px solid rgba(255,255,255,0.2);border-top-color:var(--blue-500);animation:spin 1s linear infinite;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Doctor Finder */
    #doctorFinder .finder-container{display:flex;gap:12px;height:calc(100vh - 220px)}
    #doctorFinder .finder-map{flex:1;border-radius:10px;overflow:hidden;position:relative}
    #doctorFinder .finder-sidebar{width:360px;max-width:40%;min-width:280px;overflow:auto}
    #doctorFinder .sidebar-card{padding:12px;border-radius:10px;background:white;box-shadow:0 6px 18px var(--card-shadow);margin-bottom:10px}
    #doctorFinder .facility-item{padding:10px;border-radius:10px;background:#fff;border:1px solid #eef6ff;margin-bottom:8px;cursor:pointer}
    #doctorFinder .facility-item.active{outline:3px solid rgba(59,130,246,0.12);box-shadow:0 8px 18px rgba(59,130,246,0.06)}
    #doctorFinder .facility-type{font-size:0.85rem;padding:4px 8px;border-radius:8px;background:#f1f9ff;color:var(--blue-700);font-weight:700}
    #doctorFinder .search-history{display:flex;gap:8px;align-items:center;margin-top:8px}

    /* charts */
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){ .charts-grid{grid-template-columns:1fr} }

    /* small misc */
    .muted-small{background:#f1f5f9;color:#0f172a;padding:6px;border-radius:8px}
    .sos-btn{background:var(--danger);color:#fff;border:none;border-radius:50%;width:140px;height:140px;font-size:1.6rem;font-weight:800;animation:pulse 1.5s infinite;cursor:pointer}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(220,38,38,0.6)}70%{box-shadow:0 0 0 20px rgba(220,38,38,0)}100%{box-shadow:0 0 0 0 rgba(220,38,38,0)}}
  </style>
</head>
<body>
  <header>
    <svg class="logo" viewBox="0 0 24 24"><path d="M1 12h4l3 8 4-16 3 12 3-6h4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
    <h1>Gramedics</h1>
  </header>

  <div class="hero">
    <h2>Connecting Villages to Care</h2>
    <p class="small-muted">⭐A single-page health app — trackers, services, and an AI chatbot!⭐</p>
  </div>

  <main>
    <div>
      <div class="section-header">Everyday Health & Management</div>
      <div class="features-grid">
        <div class="feature-card" id="card-symptoms"><i class="fas fa-notes-medical"></i>Symptoms Diagnosis</div>
        <div class="feature-card" id="card-stats"><i class="fas fa-chart-line"></i>Health Statistics</div>
        <div class="feature-card" id="card-family"><i class="fas fa-users"></i>Family Health Records</div>
        <div class="feature-card" id="card-nutrition"><i class="fas fa-apple-alt"></i>Nutrition & Hygiene Tips</div>
      </div>
    </div>

    <div style="margin-top:18px">
      <div class="section-header">Trackers</div>
      <div class="features-grid">
        <div class="feature-card" id="open-vaccination"><i class="fas fa-syringe"></i>Vaccination Tracking</div>
        <div class="feature-card" id="open-tracker"><i class="fas fa-pills"></i>Medicine Tracker</div>
      </div>
    </div>

    <div style="margin-top:18px">
      <div class="section-header">Services</div>
      <div class="features-grid">
        <div class="feature-card" id="card-doctors"><i class="fas fa-hospital"></i>Find Nearby Doctors</div>
        <div class="feature-card" id="open-sos"><i class="fas fa-phone-alt"></i>Emergency SOS</div>
        <div class="feature-card" id="card-drives"><i class="fas fa-bell"></i>Medical Drive Notifications</div>
        <div class="feature-card" id="card-chatbot"><i class="fas fa-robot"></i>Chat Bot for Queries</div>
      </div>
    </div>
  </main>

  <footer>&copy; 2025 Gramedics - Empowering Rural Healthcare</footer>

  <!-- UNIVERSAL SPINNER -->
  <div id="globalSpinner" class="spinner-overlay"><div class="spinner-ring">Loading...</div></div>

  <!-- ---------------- Small popups ---------------- -->
  <div id="symptomPopup" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-symptom">&times;</button>
      <h3>Symptoms Diagnosis</h3>
      <p class="small-muted">This helper suggests possible conditions — not a diagnosis.</p>
      <div class="card">
        <label>Symptoms (comma separated)</label>
        <input id="symptoms-input" placeholder="fever, cough, sore throat">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="symptoms-analyze">Analyze</button>
          <button class="muted" id="symptoms-clear">Clear</button>
        </div>
      </div>
      <div class="card">
        <h4>Suggestions</h4>
        <div id="symptom-results" class="small-muted">No analysis yet.</div>
      </div>
    </div>
  </div>

  <div id="nutritionPopup" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-nutrition">&times;</button>
      <h3>Nutrition & Hygiene Tips</h3>
      <div class="card">
        <div style="display:flex;gap:8px">
          <input id="new-tip" placeholder="Add a tip">
          <button class="muted" id="add-tip">Add</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="muted" id="random-tip">Show Random Tip</button>
          <button class="muted" id="list-tips">List All Tips</button>
        </div>
      </div>
      <div class="card">
        <h4>Tip</h4>
        <div id="tip-display" class="small-muted">No tip yet.</div>
        <div id="tips-list" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- Chatbot popup -->
  <div id="chatPopup" class="popup" aria-hidden="true">
    <div class="popup-box" style="max-width:820px">
      <button class="popup-close" id="close-chat">&times;</button>
      <h3>Chat Bot for Queries</h3>
      <p class="small-muted">AI responses via OpenAI if you supply a key. Falls back to local helper otherwise.</p>

      <div class="card" style="margin-bottom:10px;">
        <label>OpenAI API Key (paste here)</label>
        <div style="display:flex;gap:8px">
          <input id="chat-api-key" placeholder="sk-... (keep private)" type="password" style="flex:1">
          <button id="chat-save-key" class="muted">Save Key</button>
          <button id="chat-clear-key" class="muted">Clear Key</button>
        </div>
        <small class="small-muted">Key stored only in your browser (localStorage).</small>
      </div>

      <div class="card" id="chat-history" style="height:300px;overflow:auto"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chat-input" placeholder="Ask a health question...">
        <button id="chat-send">Send</button>
      </div>
      <div style="margin-top:8px"><button id="chat-clear" class="muted">Clear History</button></div>
    </div>
  </div>

  <!-- SOS popup -->
  <div id="sosModal" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-sos">&times;</button>
      <h3 style="color:var(--danger)">Emergency SOS</h3>
      <p class="small-muted">Press SOS to call emergency services (108).</p>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button class="sos-btn" id="sos-btn">SOS</button>
      </div>
    </div>
  </div>

  <!-- Medical Drives popup -->
  <div id="drivesPopup" class="popup" aria-hidden="true">
    <div class="popup-box">
      <button class="popup-close" id="close-drives">&times;</button>
      <h3>Medical Drive Notifications</h3>
      <p class="small-muted">Add local events (saved locally).</p>
      <div class="card">
        <label>Title</label><input id="drive-title" placeholder="Free Eye Checkup">
        <label>Location</label><input id="drive-loc" placeholder="Village center">
        <label>Date</label><input id="drive-date" type="date">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="add-drive">Add Drive</button>
          <button class="muted" id="clear-drives">Clear All</button>
        </div>
      </div>
      <div class="card"><h4>Upcoming Drives</h4><div id="drives-list"></div></div>
    </div>
  </div>

  <!-- Health Statistics fullscreen (dashboard style with multiple charts) -->
  <div id="statsFS" class="fullscreen" aria-hidden="true">
    <div class="fs-header"><h3>Health Statistics (Dashboard)</h3><div><button class="muted" id="export-stats-csv">Export CSV</button><button class="fs-close" id="close-stats">&times;</button></div></div>
    <div style="max-width:1100px;margin:14px auto">
      <div class="card">
        <form id="stats-form">
          <div class="col-2">
            <div><label>Date</label><input id="stat-date" type="date"></div>
            <div><label>Type</label><select id="stat-type"><option value="BP">Blood Pressure</option><option value="Sugar">Blood Sugar</option><option value="Weight">Weight (kg)</option></select></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <div style="flex:1"><label>Value</label><input id="stat-value" placeholder="e.g. 120/80 or 5.4 or 72"></div>
            <div style="width:220px"><label>&nbsp;</label><div style="display:flex;gap:8px"><button type="submit">Save</button><button type="button" class="muted" id="clear-stats">Clear All</button></div></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h4>Dashboard</h4>
        <div class="charts-grid">
          <div class="card"><h5>Blood Pressure (Latest entries)</h5><canvas id="chartBP" class="smallchart"></canvas></div>
          <div class="card"><h5>Weight (kg)</h5><canvas id="chartWeight" class="smallchart"></canvas></div>
          <div class="card"><h5>Blood Sugar</h5><canvas id="chartSugar" class="smallchart"></canvas></div>
          <div class="card"><h5>Recent Records</h5><div id="stats-list" style="max-height:260px;overflow:auto"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Family fullscreen -->
  <div id="familyFS" class="fullscreen" aria-hidden="true">
    <div class="fs-header"><h3>Family Health Records</h3><div><button class="muted" id="export-family-json">Export JSON</button><button class="fs-close" id="close-family">&times;</button></div></div>
    <div style="max-width:1000px;margin:14px auto">
      <div class="card">
        <form id="family-form">
          <div class="col-2">
            <div><label>Name</label><input id="fam-name" required></div>
            <div><label>Relation</label><input id="fam-rel" placeholder="e.g. Mother"></div>
          </div>
          <div class="col-2" style="margin-top:8px">
            <div><label>Age</label><input id="fam-age" type="number" min="0"></div>
            <div><label>Conditions / Allergies</label><input id="fam-cond" placeholder="diabetes, hypertension, penicillin allergy"></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px"><button type="submit">Add / Save</button><button type="button" class="muted" id="clear-family">Clear All</button></div>
        </form>
      </div>
      <div class="card"><h4>Family Members</h4><div id="family-list"></div></div>
    </div>
  </div>

  <!-- Medicine Tracker fullscreen -->
  <div id="trackerModal" class="fullscreen" aria-hidden="true">
    <div class="fs-header"><h3>Medicine Tracker</h3>
      <div>
        <button class="muted" id="export-med-json">Export JSON</button>
        <button class="muted" id="import-med-json">Import JSON</button>
        <button class="muted" id="export-med-csv">Export History CSV</button>
        <button class="fs-close" id="close-tracker">&times;</button>
        <input type="file" id="med-import-file" accept="application/json" style="display:none"/>
      </div>
    </div>
    <div style="max-width:1100px;margin:14px auto">
      <div class="card">
        <form id="med-form">
          <div class="col-2">
            <div><label>Name</label><input id="med-name" required placeholder="Paracetamol"></div>
            <div><label>Dose</label><input id="med-dose" placeholder="500 mg"></div>
          </div>
          <div class="col-2" style="margin-top:8px">
            <div><label>Times (HH:MM, comma separated)</label><input id="med-times" required placeholder="08:00,14:00"></div>
            <div><label>Start Date</label><input id="med-start" type="date"></div>
          </div>
          <div class="col-2" style="margin-top:8px">
            <div><label>End Date</label><input id="med-end" type="date"></div>
            <div><label>Notes</label><input id="med-notes" placeholder="Optional"></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px"><button type="submit">Add Medicine</button><button type="button" class="muted" id="med-clear-all">Clear All</button></div>
        </form>
      </div>

      <div class="card"><h4>Medicines</h4><div id="med-list"></div></div>
      <div class="card"><h4>Upcoming Doses (next 7 days)</h4><div id="upcoming-list"></div></div>
      <div class="card"><h4>History</h4><div id="history"></div></div>
      <div class="card">
        <h4>Settings</h4>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button class="muted" id="enable-notif">Enable Browser Notifications</button>
          <button class="muted" id="export-med-json-2">Export JSON</button>
          <button class="muted" id="import-med-json-2">Import JSON</button>
        </div>
        <label><input type="checkbox" id="med-sound" checked> Play sound</label><br>
        <label><input type="checkbox" id="med-pop" checked> Show fallback alert</label>
      </div>
    </div>
  </div>

  <!-- Vaccination fullscreen -->
  <div id="vaccinationModal" class="fullscreen" aria-hidden="true">
    <div class="fs-header"><h3>Vaccination Tracker</h3>
      <div>
        <button class="muted" id="export-vacc-json">Export JSON</button>
        <button class="muted" id="export-vacc-csv">Export CSV</button>
        <button class="fs-close" id="close-vaccination">&times;</button>
      </div>
    </div>

    <div style="max-width:1100px;margin:14px auto">
      <div class="card">
        <form id="vacc-form">
          <div class="col-2">
            <div><label>Name</label><input id="vacc-name" required placeholder="Hepatitis B"></div>
            <div><label>Last Date</label><input id="vacc-last" type="date"></div>
          </div>
          <div class="col-2" style="margin-top:8px">
            <div><label>Next Due Date</label><input id="vacc-next" type="date"></div>
            <div><label>Interval (days)</label><input id="vacc-interval" type="number" min="1" value="30"></div>
          </div>
          <div style="margin-top:8px" class="row">
            <div style="flex:1"><label>Total Doses</label><input id="vacc-doses" type="number" min="1" placeholder="3"></div>
            <div style="width:220px"><label>&nbsp;</label><div style="display:flex;gap:8px"><button type="submit">Add</button><button type="button" class="muted" id="vacc-clear-all">Clear</button></div></div>
          </div>
          <div style="margin-top:8px"><label>Notes</label><input id="vacc-notes" placeholder="Optional"></div>
        </form>
      </div>

      <div class="card"><h4>Vaccinations</h4><div id="vacc-list"></div></div>
      <div class="card"><h4>Statistics</h4><div id="vacc-stats"></div></div>
    </div>
  </div>

  <!-- Doctor Finder modal (sidebar + map) -->
  <div id="doctorFinder" class="fullscreen" aria-hidden="true">
    <div class="fs-header">
      <h3>Find Nearby Medical Facilities</h3>
      <div>
        <button class="muted" id="df-clear-history">Clear History</button>
        <button class="fs-close" id="df-close">&times;</button>
      </div>
    </div>

    <div style="max-width:1200px;margin:14px auto;">
      <div class="card sidebar-card" style="margin-bottom:10px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label>Location (manual)</label>
            <input id="df-location" placeholder="Enter town, village or address">
          </div>
          <div style="width:160px">
            <label>&nbsp;</label>
            <div style="display:flex;gap:8px">
              <button id="df-search">Search</button>
              <button id="df-reset" class="muted">Reset</button>
            </div>
          </div>
        </div>

        <div class="search-history" style="margin-top:10px">
          <select id="df-history-select" style="flex:1">
            <option value="">— Recent searches —</option>
          </select>
          <button id="df-use-history" class="muted">Use</button>
        </div>
      </div>

      <div id="df-content" style="display:flex;gap:12px" class="finder-container">
        <div class="finder-map card" id="df-map-wrap" style="position:relative">
          <div id="df-map" style="width:100%;height:100%"></div>
          <div id="df-spinner" class="spinner-overlay"><div class="spinner-ring">Searching...</div></div>
        </div>

        <div class="finder-sidebar">
          <div class="sidebar-card">
            <h4 style="margin:0 0 8px">Facilities</h4>
            <div id="df-results" style="max-height:calc(100vh - 260px);overflow:auto"></div>
          </div>
          <div class="sidebar-card">
            <h4 style="margin:0 0 8px">Legend</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="facility-type" style="background:#fee2e2;color:#991b1b">Hospital</div>
              <div class="facility-type" style="background:#eef2ff;color:#1e3a8a">Doctor / Clinic</div>
              <div class="facility-type" style="background:#d1fae5;color:#065f46">Pharmacy</div>
            </div>
            <p class="small-muted" style="margin-top:10px">Click a facility to zoom the map. Click markers to highlight the list.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- audio for med reminders -->
  <audio id="ping"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

  <!-- Leaflet & MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  /************************** Helpers **************************/
  const $ = id => document.getElementById(id);
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function ymdString(d){ if(!d) return null; if(typeof d === 'string') return d; const dt=new Date(d); const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), day=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function parseYMD(s){ if(!s) return null; const d = new Date(s); return isNaN(d) ? null : d; }
  function fmtLocal(d){ if(!d) return '-'; return new Date(d).toLocaleString(); }
  function showSpinner(){ $('globalSpinner').classList.add('is-visible'); }
  function hideSpinner(){ $('globalSpinner').classList.remove('is-visible'); }

  // ESC to close popups/fullscreens
  window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.popup.is-visible').forEach(p=> p.classList.remove('is-visible')); document.querySelectorAll('.fullscreen.is-visible').forEach(f=> f.classList.remove('is-visible')); } });

  /************************** Symptoms Diagnosis **************************/
  const rules = [
    { symptoms: ['fever','cough','sore throat'], suggestion: 'May be a viral upper respiratory infection. Rest & fluids; paracetamol for fever. See doctor if breathing difficulty.' },
    { symptoms: ['fever','body ache','headache'], suggestion: 'Possible influenza. Rest, hydrate, seek care if severe.' },
    { symptoms: ['chest pain','shortness of breath'], suggestion: 'Emergency sign — go to emergency services immediately.' },
    { symptoms: ['abdominal pain','vomiting'], suggestion: 'If severe or persistent, seek medical attention.' },
    { symptoms: ['headache','stiff neck','fever'], suggestion: 'Red flag — urgent medical evaluation recommended.' }
  ];
  $('card-symptoms').addEventListener('click', ()=> {window.location.href = 'nearby.html'});
  $('close-symptom').addEventListener('click', ()=> closePopup($('symptomPopup')));
  $('symptoms-analyze').addEventListener('click', ()=> {
    const raw = $('symptoms-input').value.trim().toLowerCase();
    if(!raw){ $('symptom-results').textContent='Please enter symptoms.'; return; }
    const input = raw.split(',').map(s=>s.trim());
    const matches = [];
    for(const r of rules) if(r.symptoms.every(s=>input.includes(s))) matches.push(r.suggestion);
    if(matches.length) $('symptom-results').innerHTML = matches.map(m=>`<div>${escapeHtml(m)}</div>`).join('');
    else $('symptom-results').textContent = 'No direct match. Seek professional help if symptoms are serious.';
  });
  $('symptoms-clear').addEventListener('click', ()=> { $('symptoms-input').value=''; $('symptom-results').textContent='No analysis yet.'; });

  function openPopup(el){ el.classList.add('is-visible'); el.setAttribute('aria-hidden','false'); }
  function closePopup(el){ el.classList.remove('is-visible'); el.setAttribute('aria-hidden','true'); }

  /************************** Nutrition Tips **************************/
  const TIP_KEY = 'grams_tips_v1'; let tips=[];
  function tipsLoad(){ try{ tips = JSON.parse(localStorage.getItem(TIP_KEY) || '[]'); }catch(e){ tips=[]; } }
  function tipsSave(){ localStorage.setItem(TIP_KEY, JSON.stringify(tips)); }
  tipsLoad(); if(tips.length===0){ tips=['Eat fruits and vegetables daily.','Wash hands before meals and after toilet.','Drink safe water.','Include protein sources in diet.','Keep food covered.']; tipsSave(); }
  $('card-nutrition').addEventListener('click', ()=> { tipsLoad(); $('tip-display').textContent = tips[0] || 'No tip yet.'; openPopup($('nutritionPopup')); });
  $('close-nutrition').addEventListener('click', ()=> closePopup($('nutritionPopup')));
  $('add-tip').addEventListener('click', ()=> { const t=$('new-tip').value.trim(); if(!t) return alert('Enter a tip'); tips.push(t); tipsSave(); $('new-tip').value=''; alert('Tip added'); });
  $('random-tip').addEventListener('click', ()=> { tipsLoad(); $('tip-display').textContent = tips.length ? tips[Math.floor(Math.random()*tips.length)] : 'No tips.'; });
  $('list-tips').addEventListener('click', ()=> { tipsLoad(); $('tips-list').innerHTML = tips.map((t,i)=>`<div class="list-row">${escapeHtml(t)} <button class="muted" data-i="${i}" onclick="deleteTip(event)">Delete</button></div>`).join('') || '<p class="small-muted">No tips</p>'; });
  window.deleteTip = function(ev){ const i=Number(ev.target.getAttribute('data-i')); if(!isFinite(i)) return; if(!confirm('Delete tip?')) return; tips.splice(i,1); tipsSave(); $('list-tips').click(); };

  /************************** Drives **************************/
  const DRIVES_KEY = 'grams_drives_v1'; let drives=[];
  function drivesLoad(){ try{ drives = JSON.parse(localStorage.getItem(DRIVES_KEY) || '[]'); }catch(e){ drives=[]; } }
  function drivesSave(){ localStorage.setItem(DRIVES_KEY, JSON.stringify(drives)); }
  drivesLoad(); function drivesRender(){ $('drives-list').innerHTML = drives.length ? drives.map(d=>`<div class="list-row"><div><strong>${escapeHtml(d.title)}</strong><div class="small-muted">${escapeHtml(d.loc)} • ${d.date}</div></div><div><button class="muted" data-id="${d.id}">Remove</button></div></div>`).join('') : '<p class="small-muted">No drives yet.</p>'; document.querySelectorAll('#drives-list button[data-id]').forEach(b=>b.addEventListener('click', ()=>{ drives = drives.filter(x=>x.id !== b.getAttribute('data-id')); drivesSave(); drivesRender(); })); }
  $('card-drives').addEventListener('click', ()=> { drivesLoad(); drivesRender(); openPopup($('drivesPopup')); });
  $('close-drives').addEventListener('click', ()=> closePopup($('drivesPopup')));
  $('add-drive').addEventListener('click', ()=> { const t=$('drive-title').value.trim(); const l=$('drive-loc').value.trim(); const d=$('drive-date').value; if(!t||!d) return alert('Enter title and date'); drives.push({id:uid('drive'),title:t,loc:l,date:d}); drivesSave(); drivesRender(); $('drive-title').value=''; $('drive-loc').value=''; $('drive-date').value=''; });
  $('clear-drives').addEventListener('click', ()=> { if(confirm('Clear all drives?')){ drives=[]; drivesSave(); drivesRender(); }});

  /************************** Chatbot (AI) **************************/
  const CHAT_KEY = 'grams_chat_v2'; const OPENAI_KEY_STORAGE = 'openai_api_key_v1';
  let chats = JSON.parse(localStorage.getItem(CHAT_KEY) || '[]');
  function chatSave(){ localStorage.setItem(CHAT_KEY, JSON.stringify(chats)); }
  function chatRender(){ $('chat-history').innerHTML = chats.length ? chats.map(m=>`<div style="margin-bottom:8px;"><strong>You:</strong><div class="small-muted">${escapeHtml(m.user)}</div><div style="margin-top:6px;color:#0b5fff"><strong>AI:</strong> ${escapeHtml(m.ai)}</div></div>`).join('') : '<p class="small-muted">No messages yet.</p>'; $('chat-history').scrollTop = $('chat-history').scrollHeight; }
  $('card-chatbot').addEventListener('click', ()=> { const stored = localStorage.getItem(OPENAI_KEY_STORAGE) || ''; $('chat-api-key').value = stored ? '••••••' : ''; openPopup($('chatPopup')); chatRender(); });
  $('close-chat').addEventListener('click', ()=> closePopup($('chatPopup')));
  $('chat-save-key').addEventListener('click', ()=> { const val = $('chat-api-key').value.trim(); if(!val) return alert('Enter OpenAI API key'); if(val === '••••••' || val === '******'){ alert('To replace existing key, paste the full key'); return; } localStorage.setItem(OPENAI_KEY_STORAGE, val); alert('API key saved locally'); $('chat-api-key').value='••••••'; });
  $('chat-clear-key').addEventListener('click', ()=> { if(confirm('Remove stored OpenAI API key?')){ localStorage.removeItem(OPENAI_KEY_STORAGE); $('chat-api-key').value=''; alert('Key cleared'); }});
  function fallbackBot(q){ const t=q.toLowerCase(); if(t.includes('fever')) return 'Fever: rest, hydrate, paracetamol if needed. See doctor for high fever or breathing difficulty.'; if(t.includes('covid')) return 'Isolate and test for COVID; seek care for breathing issues.'; if(t.includes('headache')) return 'Mild headache: rest and hydrate. Seek care for sudden/severe pain.'; return 'I can provide general info. To enable AI answers, paste your OpenAI API key in settings.'; }
  async function aiRespond(question){ const key = localStorage.getItem(OPENAI_KEY_STORAGE); if(!key) return fallbackBot(question); try{ const body = { model:'gpt-3.5-turbo', messages:[{role:'system',content:'You are a cautious medical assistant. Provide general info and always advise seeking professional care for serious symptoms.'},{role:'user',content:question}], max_tokens:300, temperature:0.2 }; const res = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)}); if(!res.ok){ console.error('OpenAI error', await res.text()); return 'AI service error — falling back to basic help.'; } const data = await res.json(); return data?.choices?.[0]?.message?.content?.trim() || 'No response from AI.'; }catch(e){ console.error(e); return 'AI request failed — falling back to basic help.'; } }
  $('chat-send').addEventListener('click', async ()=>{ const q=$('chat-input').value.trim(); if(!q) return; $('chat-input').value=''; chats.push({user:q,ai:'...'}); chatSave(); chatRender(); const idx = chats.length-1; const resp = await aiRespond(q); chats[idx].ai = resp; chatSave(); chatRender(); });
  $('chat-clear').addEventListener('click', ()=> { if(confirm('Clear chat history?')){ chats=[]; chatSave(); chatRender(); }});
  chatRender();

  /************************** Health Statistics (dashboard) **************************/
  const STATS_KEY = 'grams_stats_v2'; let stats = [];
  function statsLoad(){ try{ stats = JSON.parse(localStorage.getItem(STATS_KEY) || '[]'); }catch(e){ stats=[]; } }
  function statsSave(){ localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }
  function statsRenderList(){ const el = $('stats-list'); el.innerHTML=''; if(!stats.length) { el.innerHTML='<p class="small-muted">No records yet.</p>'; return; } stats.slice().reverse().forEach(s=>{ const row = document.createElement('div'); row.className='list-row'; row.innerHTML = `<div><strong>${escapeHtml(s.type)}</strong><div class="small-muted">${s.date} • ${escapeHtml(s.value)}</div></div><div><button class="muted" data-id="${s.id}">Remove</button></div>`; el.appendChild(row); }); el.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click', ()=>{ stats = stats.filter(x=>x.id !== b.getAttribute('data-id')); statsSave(); statsRenderAll(); })); }
  function statsRenderAll(){ statsRenderList(); drawAllCharts(); }
  $('card-stats').addEventListener('click', ()=>{ statsLoad(); statsRenderAll(); $('statsFS').classList.add('is-visible'); $('statsFS').setAttribute('aria-hidden','false'); });
  $('close-stats').addEventListener('click', ()=>{ $('statsFS').classList.remove('is-visible'); $('statsFS').setAttribute('aria-hidden','true'); });
  $('stats-form').addEventListener('submit', (e)=>{ e.preventDefault(); const date = $('stat-date').value || ymdString(new Date()); const type = $('stat-type').value; const value = $('stat-value').value.trim(); if(!value){ alert('Enter a value'); return; } stats.push({id:uid('s'), date, type, value}); statsSave(); statsRenderAll(); $('stat-value').value=''; $('stat-date').value=''; });
  $('clear-stats').addEventListener('click', ()=>{ if(confirm('Clear all stats?')){ stats=[]; statsSave(); statsRenderAll(); }});
  $('export-stats-csv').addEventListener('click', ()=>{ showSpinner(); setTimeout(()=>{ const rows=[['Date','Type','Value']]; stats.forEach(s=> rows.push([s.date, s.type, `"${String(s.value).replace(/"/g,'""')}"`])); const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='health-stats.csv'; a.click(); URL.revokeObjectURL(a.href); hideSpinner(); }, 300); });

  // Very simple canvas charts (no external libs)
  function drawChart(canvasId, series, label){
    const canvas = $(canvasId); if(!canvas) return;
    const ctx = canvas.getContext('2d'); canvas.width = canvas.clientWidth; canvas.height = 160;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!series || series.length===0){ ctx.fillStyle='#94a3b8'; ctx.font='14px Poppins'; ctx.fillText('No data',12,24); return; }
    const ys = series.map(s=>s.y).filter(v=>!isNaN(v));
    if(ys.length===0){ ctx.fillStyle='#94a3b8'; ctx.font='14px Poppins'; ctx.fillText('Not numeric data',12,24); return; }
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const pad = 10, w = canvas.width - pad*2, h = canvas.height - pad*2;
    const step = w / (series.length - 1 || 1);
    ctx.beginPath(); ctx.strokeStyle = '#0b84ff'; ctx.lineWidth = 2;
    series.forEach((pt,i)=>{ const vx = pad + i*step; const vy = pad + h - ((pt.y - minY)/(maxY-minY||1))*h; if(i===0) ctx.moveTo(vx,vy); else ctx.lineTo(vx,vy); });
    ctx.stroke();
    ctx.fillStyle = '#0b84ff';
    series.forEach((pt,i)=>{ const vx = pad + i*step; const vy = pad + h - ((pt.y - minY)/(maxY-minY||1))*h; ctx.beginPath(); ctx.arc(vx,vy,3,0,Math.PI*2); ctx.fill(); });
    ctx.fillStyle = '#111827'; ctx.font='12px Poppins'; ctx.fillText(label, 12, 14);
  }

  function drawAllCharts(){
    // prepare series
    const bp = stats.filter(s=>s.type==='BP').slice(-12).map(s=>({x:s.date,y: (()=>{ const v = s.value.split('/')[0]; const n = Number(v); return isNaN(n)?NaN:n; })()}));
    const weight = stats.filter(s=>s.type==='Weight').slice(-12).map(s=>({x:s.date,y:Number(s.value)}));
    const sugar = stats.filter(s=>s.type==='Sugar').slice(-12).map(s=>({x:s.date,y:Number(s.value)}));
    drawChart('chartBP', bp, 'Systolic (BP - approximate)');
    drawChart('chartWeight', weight, 'Weight (kg)');
    drawChart('chartSugar', sugar, 'Blood Sugar');
    statsRenderList();
  }
  statsLoad(); statsRenderAll();

  /************************** Family Records **************************/
  const FAMILY_KEY = 'grams_family_v1'; let family=[];
  function familyLoad(){ try{ family = JSON.parse(localStorage.getItem(FAMILY_KEY) || '[]'); }catch(e){ family=[]; } }
  function familySave(){ localStorage.setItem(FAMILY_KEY, JSON.stringify(family)); }
  function familyRender(){ const el=$('family-list'); el.innerHTML=''; if(family.length===0){ el.innerHTML='<p class="small-muted">No family members.</p>'; return; } family.forEach(f=>{ const div=document.createElement('div'); div.className='list-row'; div.innerHTML = `<div><strong>${escapeHtml(f.name)}</strong><div class="small-muted">${escapeHtml(f.relation)} • Age ${escapeHtml(String(f.age||'-'))}</div><div class="small-muted">${escapeHtml(f.conditions||'')}</div></div><div><button class="muted" data-id="${f.id}" data-act="edit">Edit</button><button class="muted" data-id="${f.id}" data-act="delete">Delete</button></div>`; el.appendChild(div); }); el.querySelectorAll('button[data-act]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'), act=b.getAttribute('data-act'); const item = family.find(x=>x.id===id); if(act==='edit' && item){ $('fam-name').value=item.name; $('fam-rel').value=item.relation; $('fam-age').value=item.age||''; $('fam-cond').value=item.conditions||''; family = family.filter(x=>x.id !== id); familySave(); familyRender(); } else if(act==='delete'){ if(confirm('Delete member?')){ family = family.filter(x=>x.id !== id); familySave(); familyRender(); } } })); }
  $('card-family').addEventListener('click', ()=> { familyLoad(); familyRender(); $('familyFS').classList.add('is-visible'); $('familyFS').setAttribute('aria-hidden','false'); });
  $('close-family').addEventListener('click', ()=> { $('familyFS').classList.remove('is-visible'); $('familyFS').setAttribute('aria-hidden','true'); });
  $('family-form').addEventListener('submit', (e)=>{ e.preventDefault(); const name=$('fam-name').value.trim(); if(!name) return alert('Enter name'); const rel=$('fam-rel').value.trim(); const age=$('fam-age').value ? Number($('fam-age').value) : null; const cond=$('fam-cond').value.trim(); family.push({ id: uid('fam'), name, relation: rel, age, conditions: cond }); familySave(); familyRender(); e.target.reset(); });
  $('clear-family').addEventListener('click', ()=> { if(confirm('Clear all family records?')){ family=[]; familySave(); familyRender(); }});
  $('export-family-json').addEventListener('click', ()=> { const blob=new Blob([JSON.stringify(family,null,2)],[{type:'application/json'}]); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='family-records.json'; a.click(); URL.revokeObjectURL(a.href); });

  /************************** Medicine Tracker **************************/
  const MED_KEY = 'medtracker_v2'; let medState = { meds:[], history:[] };
  function medLoad(){ try{ medState = JSON.parse(localStorage.getItem(MED_KEY) || JSON.stringify({meds:[],history:[]})); }catch(e){ medState = { meds:[], history:[] }; } }
  function medSave(){ localStorage.setItem(MED_KEY, JSON.stringify(medState)); }
  function medRenderList(){ const el = $('med-list'); el.innerHTML=''; if(medState.meds.length===0){ el.innerHTML='<p class="small-muted">No medicines added.</p>'; return; } medState.meds.forEach(m=>{ const div=document.createElement('div'); div.className='list-row'; div.innerHTML=`<div><strong>${escapeHtml(m.name)}</strong><div class="small-muted">${escapeHtml(m.dose||'')} • ${escapeHtml((m.times||[]).join(', '))}</div></div><div><button class="muted" data-id="${m.id}" data-act="edit">Edit</button><button class="muted" data-id="${m.id}" data-act="delete">Delete</button></div>`; el.appendChild(div); }); el.querySelectorAll('button[data-act]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act'); if(act==='delete'){ if(confirm('Delete medicine?')){ medState.meds = medState.meds.filter(x=>x.id !== id); medSave(); medRenderAll(); } } else { const m = medState.meds.find(x=>x.id===id); if(m){ $('med-name').value=m.name; $('med-dose').value=m.dose||''; $('med-times').value=(m.times||[]).join(', '); $('med-start').value=m.startDate||''; $('med-end').value=m.endDate||''; $('med-notes').value=m.notes||''; medState.meds = medState.meds.filter(x=>x.id!==id); medSave(); medRenderAll(); } } })); }
  function medGetUpcoming(days=7){ const out=[]; const now=new Date(); medState.meds.forEach(m=>{ const start = m.startDate ? parseYMD(m.startDate) : null; const end = m.endDate ? parseYMD(m.endDate) : null; for(let i=0;i<=days;i++){ const day = new Date(now); day.setDate(now.getDate()+i); if(start && day < start) continue; if(end && day > end) continue; (m.times||[]).forEach(t=>{ const parts = t.split(':').map(x=>Number(x)); const sched = new Date(day.getFullYear(), day.getMonth(), day.getDate(), parts[0]||0, parts[1]||0, 0, 0); out.push({ med:m, scheduledAt: sched }); }); } }); out.sort((a,b)=>a.scheduledAt - b.scheduledAt); return out; }
  function medRenderUpcoming(){ const el=$('upcoming-list'); el.innerHTML=''; const list = medGetUpcoming(7); if(list.length===0){ el.innerHTML='<p class="small-muted">No upcoming doses in next 7 days.</p>'; return; } list.forEach(item=>{ const div=document.createElement('div'); div.className='list-row'; div.innerHTML = `<div><strong>${escapeHtml(item.med.name)}</strong><div class="small-muted">${fmtLocal(item.scheduledAt)}</div></div><div><button class="muted" data-id="${item.med.id}" data-s="${item.scheduledAt.toISOString()}">Mark Taken</button></div>`; el.appendChild(div); }); el.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click', ()=> medMarkTaken(b.getAttribute('data-id'), b.getAttribute('data-s')))); }
  function medRenderHistory(){ const el=$('history'); el.innerHTML=''; if(!medState.history || medState.history.length===0){ el.innerHTML='<p class="small-muted">No history yet.</p>'; return; } medState.history.slice().reverse().forEach(h=>{ const div=document.createElement('div'); div.className='list-row'; div.innerHTML=`<div><strong>${escapeHtml(h.name)}</strong><div class="small-muted">Scheduled: ${fmtLocal(h.scheduledAt)} • Taken: ${fmtLocal(h.takenAt)}</div></div>`; el.appendChild(div); }); }
  function medMarkTaken(medId, sISO){ const m = medState.meds.find(x=>x.id===medId); if(!m) return; medState.history.push({ id: uid('mh'), medId: m.id, name: m.name, dose: m.dose||'', scheduledAt: sISO||new Date().toISOString(), takenAt: new Date().toISOString() }); medSave(); medRenderHistory(); medRenderUpcoming(); }
  $('med-form').addEventListener('submit', (e)=>{ e.preventDefault(); const name=$('med-name').value.trim(); if(!name) return alert('Enter name'); const dose=$('med-dose').value.trim(); const timesRaw=$('med-times').value.trim(); const times=timesRaw.split(',').map(s=>s.trim()).filter(Boolean).map(t=>{ const p=t.split(':'); if(p.length===1) p.push('00'); const hh=Number(p[0]), mm=Number(p[1]); if(Number.isNaN(hh)||Number.isNaN(mm)) return null; return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; }); if(times.includes(null)) return alert('Invalid time format'); const start=$('med-start').value||null; const end=$('med-end').value||null; const notes=$('med-notes').value||''; medState.meds.push({ id: uid('med'), name, dose, times, startDate:start, endDate:end, notes }); medSave(); medRenderAll(); e.target.reset(); });
  $('med-clear-all').addEventListener('click', ()=>{ if(confirm('Clear all medicines and history?')){ medState={meds:[],history:[]}; medSave(); medRenderAll(); }});
  $('export-med-json').addEventListener('click', ()=> { showSpinner(); setTimeout(()=>{ const blob=new Blob([JSON.stringify(medState,null,2)],[{type:'application/json'}]); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medtracker.json'; a.click(); URL.revokeObjectURL(a.href); hideSpinner(); },300); });
  $('export-med-json-2')?.addEventListener('click', ()=> $('export-med-json').click());
  $('export-med-csv').addEventListener('click', ()=> { const rows=[['Name','Dose','ScheduledAt','TakenAt']]; (medState.history||[]).forEach(h=> rows.push([h.name,h.dose,h.scheduledAt,h.takenAt])); const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'); showSpinner(); setTimeout(()=>{ const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medtracker-history.csv'; a.click(); URL.revokeObjectURL(a.href); hideSpinner(); },300); });
  $('import-med-json').addEventListener('click', ()=> $('med-import-file').click());
  $('import-med-json-2')?.addEventListener('click', ()=> $('med-import-file').click());
  $('med-import-file').addEventListener('change', (ev)=>{ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(e)=>{ try{ const obj=JSON.parse(e.target.result); if(obj && obj.meds!==undefined && obj.history!==undefined){ medState=obj; medSave(); medRenderAll(); alert('Imported'); } else alert('Invalid file'); }catch(err){ alert('Failed import: '+err.message); } }; r.readAsText(f); ev.target.value=''; });

  // Notifications & reminder loop
  $('enable-notif').addEventListener('click', async ()=>{ if(!('Notification' in window)) return alert('Notifications not supported'); const p = await Notification.requestPermission(); alert('Notification permission: ' + p); });
  function medNotify(med, scheduledAt){ const title = `Time to take: ${med.name}`; const body = `${med.dose ? med.dose + ' • ' : ''}${fmtLocal(scheduledAt)}`; if(Notification.permission === 'granted'){ try{ new Notification(title,{body}); }catch(e){} } else if($('med-pop').checked){ alert(title + '\n' + body); } if($('med-sound').checked) $('ping').play().catch(()=>{}); }
  let notifiedSet = new Set();
  function medStartLoop(){ setInterval(()=>{ const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0'); const current = `${hh}:${mm}`; const todayStr = ymdString(now); medState.meds.forEach(m=>{ if(m.times && m.times.includes(current)){ const start = m.startDate ? parseYMD(m.startDate) : null; const end = m.endDate ? parseYMD(m.endDate) : null; const today = new Date(); today.setHours(0,0,0,0); if(start && today < start) return; if(end && today > end) return; const key = `${m.id}::${todayStr}::${current}`; if(notifiedSet.has(key)) return; notifiedSet.add(key); medNotify(m, new Date()); } }); },15000); }
  function medRenderAll(){ medRenderList(); medRenderUpcoming(); medRenderHistory(); }
  medLoad(); medRenderAll(); medStartLoop();

  /************************** Vaccination Tracker **************************/
  const VACC_KEY = 'vacctracker_v2'; let vaccs = [];
  function vaccLoad(){ try{ vaccs = JSON.parse(localStorage.getItem(VACC_KEY) || '[]'); }catch(e){ vaccs=[]; } }
  function vaccSave(){ localStorage.setItem(VACC_KEY, JSON.stringify(vaccs)); }
  function vaccGetStatus(v){ const today = new Date(); today.setHours(0,0,0,0); const next = v.next ? parseYMD(v.next) : null; const last = v.last ? parseYMD(v.last) : null; if(!next && !last) return 'not-started'; if(next){ const diff = Math.round((next.setHours(0,0,0,0) - today.getTime())/86400000); if(diff < 0) return 'overdue'; if(diff <= 30) return 'upcoming'; return 'up-to-date'; } return last ? 'up-to-date' : 'not-started'; }
  function vaccRenderAll(){ const el=$('vacc-list'); el.innerHTML=''; if(vaccs.length===0){ el.innerHTML='<p class="small-muted">No vaccinations recorded.</p>'; vaccRenderStats(); return; } vaccs.forEach(v=>{ const status = vaccGetStatus(v); const completedToday = v.last && (v.last === ymdString(new Date())); const div=document.createElement('div'); div.className='list-row'; div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(v.name)}</strong> <span class="status ${escapeHtml(status)}">${escapeHtml(status)}</span><div class="small-muted">Last: ${escapeHtml(v.last||'-')} • Next: ${escapeHtml(v.next||'-')}</div><div class="small-muted">Doses: ${escapeHtml(String(v.doses||'-'))} • Interval: ${escapeHtml(String(v.interval||'-'))} days</div><div style="margin-top:6px">${escapeHtml(v.notes||'')}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class="muted" data-id="${v.id}" data-act="edit">Edit</button><button class="muted" data-id="${v.id}" data-act="delete">Delete</button><button class="muted mark-btn" data-id="${v.id}" ${completedToday ? 'disabled' : ''}>${completedToday ? 'Completed Today' : 'Mark as Completed'}</button></div>`; el.appendChild(div); }); el.querySelectorAll('button[data-act]').forEach(b=>b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'), act=b.getAttribute('data-act'); if(act==='delete'){ if(confirm('Delete vaccination?')){ vaccs=vaccs.filter(x=>x.id!==id); vaccSave(); vaccRenderAll(); } } else { const item = vaccs.find(x=>x.id===id); if(item){ $('vacc-name').value=item.name; $('vacc-last').value=item.last||''; $('vacc-next').value=item.next||''; $('vacc-doses').value=item.doses||''; $('vacc-interval').value=item.interval||30; $('vacc-notes').value=item.notes||''; vaccs=vaccs.filter(x=>x.id!==id); vaccSave(); vaccRenderAll(); } } })); el.querySelectorAll('.mark-btn').forEach(b=>b.addEventListener('click', ()=> vaccMarkCompleted(b.getAttribute('data-id')))); vaccRenderStats(); }
  function vaccRenderStats(){ const s={'up-to-date':0, overdue:0, upcoming:0, 'not-started':0}; vaccs.forEach(v=> s[vaccGetStatus(v)] = (s[vaccGetStatus(v)]||0) + 1 ); $('vacc-stats').innerHTML = `<ul style="margin:0;padding-left:18px"><li>Up-to-date: ${s['up-to-date']}</li><li>Upcoming: ${s['upcoming']}</li><li>Overdue: ${s['overdue']}</li><li>Not started: ${s['not-started']}</li><li>Total: ${vaccs.length}</li></ul>`; }
  $('open-vaccination').addEventListener('click', ()=>{ vaccLoad(); vaccRenderAll(); $('vaccinationModal').classList.add('is-visible'); $('vaccinationModal').setAttribute('aria-hidden','false'); });
  $('close-vaccination').addEventListener('click', ()=>{ $('vaccinationModal').classList.remove('is-visible'); $('vaccinationModal').setAttribute('aria-hidden','true'); });
  $('vacc-form').addEventListener('submit', (e)=>{ e.preventDefault(); const name=$('vacc-name').value.trim(); if(!name) return alert('Enter vaccine name'); const last=$('vacc-last').value||null; const next=$('vacc-next').value||null; const doses=$('vacc-doses').value||null; const interval=Number($('vacc-interval').value)||30; const notes=$('vacc-notes').value||''; vaccs.push({ id: uid('vacc'), name, last, next, doses, interval, notes }); vaccSave(); vaccRenderAll(); e.target.reset(); $('vacc-interval').value=30; });
  function vaccMarkCompleted(id){ const v=vaccs.find(x=>x.id===id); if(!v) return; const today=new Date(); const tstr=ymdString(today); if(v.last && v.last===tstr) return; v.last = tstr; const interval=Number(v.interval)||30; const next=new Date(today); next.setDate(today.getDate()+interval); v.next = ymdString(next); vaccSave(); vaccRenderAll(); }
  $('vacc-clear-all').addEventListener('click', ()=>{ if(confirm('Clear vaccinations?')){ vaccs=[]; vaccSave(); vaccRenderAll(); }});
  $('export-vacc-json').addEventListener('click', ()=>{ showSpinner(); setTimeout(()=>{ const blob=new Blob([JSON.stringify(vaccs,null,2)],[{type:'application/json'}]); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vaccinations.json'; a.click(); URL.revokeObjectURL(a.href); hideSpinner(); },300); });
  $('export-vacc-csv').addEventListener('click', ()=>{ const hdr=['Name','Last','Next','Doses','Interval','Notes','Status']; const rows=[hdr.join(',')]; vaccs.forEach(v=> rows.push([`"${(v.name||'').replace(/"/g,'""')}"`,`"${(v.last||'').replace(/"/g,'""')}"`,`"${(v.next||'').replace(/"/g,'""')}"`,`"${String(v.doses||'').replace(/"/g,'""')}"`,`"${String(v.interval||'').replace(/"/g,'""')}"`,`"${(v.notes||'').replace(/"/g,'""')}"`,`"${vaccGetStatus(v)}"`].join(','))); showSpinner(); setTimeout(()=>{ const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vaccinations.csv'; a.click(); URL.revokeObjectURL(a.href); hideSpinner(); },300); });
  vaccLoad(); vaccRenderAll();

  /************************** Doctor Finder (map + sidebar) **************************/
  // Elements
  const DF = { modal: $('doctorFinder'), mapWrap: $('df-map-wrap'), mapEl: $('df-map'), resultsEl: $('df-results'), spinner: $('df-spinner'), locInput: $('df-location'), btnSearch: $('df-search'), btnReset: $('df-reset'), historySelect: $('df-history-select'), btnUseHistory: $('df-use-history'), clearHistoryBtn: $('df-clear-history'), dfClose: $('df-close') };
  const DF_HISTORY_KEY = 'df_history_v1';
  function dfLoadHistory(){ try{ return JSON.parse(localStorage.getItem(DF_HISTORY_KEY) || '[]'); }catch(e){ return []; } }
  function dfSaveHistory(arr){ localStorage.setItem(DF_HISTORY_KEY, JSON.stringify(arr)); }
  function dfAddToHistory(q){ if(!q) return; let arr = dfLoadHistory(); arr = arr.filter(x=>x!==q); arr.unshift(q); if(arr.length>5) arr = arr.slice(0,5); dfSaveHistory(arr); dfRenderHistory(); }
  function dfRenderHistory(){ const arr=dfLoadHistory(); DF.historySelect.innerHTML = `<option value="">— Recent searches —</option>` + arr.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join(''); }
  DF.clearHistoryBtn.addEventListener('click', ()=> { if(confirm('Clear search history?')){ dfSaveHistory([]); dfRenderHistory(); }});

  // Spinner for doctor finder (map overlay)
  function showDfSpinner(){ DF.spinner.classList.add('is-visible'); }
  function hideDfSpinner(){ DF.spinner.classList.remove('is-visible'); }

  // Map init
  let map, clusterGroup, markers=[];
  function createSvgIcon(color){
    const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40"><path d="M16 0C9 0 4 6 4 11c0 8 12 22 12 22s12-14 12-22c0-5-5-11-12-11z" fill="${color}"/></svg>`);
    return L.icon({ iconUrl:`data:image/svg+xml;charset=utf-8,${svg}`, iconSize:[32,40], iconAnchor:[16,40], popupAnchor:[0,-36] });
  }
  const ICONS = { hospital: createSvgIcon('#ef4444'), clinic: createSvgIcon('#2563eb'), pharmacy: createSvgIcon('#16a34a') };

  function initMapIfNeeded(){
    if(map) return;
    map = L.map('df-map',{zoomControl:true});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
    clusterGroup = L.markerClusterGroup();
    clusterGroup.addTo(map);
    map.setView([20.5937,78.9629],5);
  }

  function clearDfMarkers(){ markers=[]; clusterGroup.clearLayers(); DF.resultsEl.innerHTML = '<p class="small-muted">No results yet.</p>'; }

  function highlightListItem(id){
    document.querySelectorAll('#df-results .facility-item').forEach(el=>el.classList.remove('active'));
    const el = document.querySelector(`#df-results .facility-item[data-id="${id}"]`);
    if(el){ el.classList.add('active'); el.scrollIntoView({behavior:'smooth',block:'nearest'}); }
  }

  function addFacilityToSidebar(f,id){
    const phone = f.tags.phone || f.tags['contact:phone'] || '';
    const web = f.tags.website || f.tags.url || '';
    const hours = f.tags.opening_hours || '';
    const addr = [f.tags['addr:street']||'', f.tags['addr:city']||'', f.tags['addr:postcode']||'', f.tags['addr:country']||''].filter(Boolean).join(', ');
    const typeLabel = (f.tags.amenity === 'hospital') ? 'Hospital' : ((f.tags.amenity === 'pharmacy') ? 'Pharmacy' : 'Clinic/Doctor');
    const html = `<div class="facility-item" data-id="${id}"><div style="display:flex;justify-content:space-between;align-items:start"><div style="flex:1"><div style="font-weight:700">${escapeHtml(f.tags.name || f.tags.operator || 'Unnamed')}</div><div class="small-muted" style="margin-top:6px">${escapeHtml(typeLabel)} • ${escapeHtml(addr || (f.tags.name ? '' : 'No address'))}</div><div style="margin-top:6px" class="small-muted">${phone ? '📞 ' + escapeHtml(phone) : ''} ${web ? ' • 🔗 ' + `<a href="${escapeHtml(web)}" target="_blank" rel="noreferrer">${escapeHtml(web)}</a>` : ''}</div><div style="margin-top:6px" class="small-muted">${hours ? '⏰ ' + escapeHtml(hours) : ''}</div></div></div></div>`; DF.resultsEl.insertAdjacentHTML('beforeend', html);
    const newEl = DF.resultsEl.querySelector(`.facility-item[data-id="${id}"]`);
    newEl.addEventListener('click', ()=>{ const mobj = markers.find(m=>m.id===id); if(mobj && map){ map.setView(mobj.latlng,17,{animate:true}); mobj.marker.openPopup(); highlightListItem(id); } });
  }

  function buildOverpassQuery(lat,lon,radius=3000){
    return `[out:json][timeout:25];
    (
      node(around:${radius},${lat},${lon})[amenity~"^(doctor|clinic|hospital|pharmacy)$"];
      way(around:${radius},${lat},${lon})[amenity~"^(doctor|clinic|hospital|pharmacy)$"];
      relation(around:${radius},${lat},${lon})[amenity~"^(doctor|clinic|hospital|pharmacy)$"];
    );
    out center;`;
  }

  async function geocode(q){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
    const res = await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('Geocode failed: '+res.status);
    const data = await res.json();
    return data[0] ? {lat:parseFloat(data[0].lat), lon:parseFloat(data[0].lon), display_name: data[0].display_name} : null;
  }
  async function runOverpass(lat,lon,radius){
    const query = buildOverpassQuery(lat,lon,radius);
    const url = 'https://overpass-api.de/api/interpreter';
    const res = await fetch(url,{method:'POST',body:query,headers:{'Content-Type':'text/plain'}});
    if(!res.ok) throw new Error('Overpass error: '+res.status);
    const data = await res.json();
    const elements = data.elements.map(el=>{
      if(el.type==='node') return el;
      if(el.type==='way' || el.type==='relation'){ const lat = el.center?.lat || el.lat || null; const lon = el.center?.lon || el.lon || null; return Object.assign({},el,{lat,lon}); }
      return el;
    }).filter(e=>e.lat && e.lon);
    return elements;
  }

  function placeFacilitiesOnMap(elements){
    clearDfMarkers();
    elements.forEach(el=>{
      const amen = (el.tags && el.tags.amenity) || 'clinic';
      let icon = ICONS.clinic;
      if(amen==='hospital') icon = ICONS.hospital;
      else if(amen==='pharmacy') icon = ICONS.pharmacy;
      const latlng = L.latLng(el.lat, el.lon);
      const popupHtml = `<div style="min-width:180px"><strong>${escapeHtml(el.tags.name || el.tags.operator || 'Unnamed')}</strong><div class="small-muted">${escapeHtml(amen)}</div><div class="small-muted" style="margin-top:6px">${escapeHtml(el.tags['addr:street']||'')}${el.tags['addr:city']?(', '+escapeHtml(el.tags['addr:city'])):''}</div>${el.tags.phone?('<div style="margin-top:6px">📞 '+escapeHtml(el.tags.phone)+'</div>'):''}${el.tags.website?('<div style="margin-top:6px">🔗 <a href="'+escapeHtml(el.tags.website)+'" target="_blank" rel="noreferrer">'+escapeHtml(el.tags.website)+'</a></div>'):''}</div>`;
      const marker = L.marker(latlng,{icon}).bindPopup(popupHtml);
      const id = uid('fac');
      clusterGroup.addLayer(marker);
      markers.push({ id, marker, latlng, data: el });
      addFacilityToSidebar(el,id);
      marker.on('click', ()=> highlightListItem(id));
    });
    if(markers.length){
      const group = L.featureGroup(markers.map(m=>m.marker));
      map.fitBounds(group.getBounds().pad(0.2));
    } else {
      map.setView([20.5937,78.9629],6);
    }
  }

  async function dfSearchFlow(query){
    try{
      showDfSpinner(); // local map spinner
      initMapIfNeeded();
      clearDfMarkers();
      const geo = await geocode(query);
      if(!geo){ hideDfSpinner(); alert('Location not found. Try more specific input.'); return; }
      dfAddToHistory(query);
      map.setView([geo.lat, geo.lon], 14);
      const elements = await runOverpass(geo.lat, geo.lon, 3000);
      placeFacilitiesOnMap(elements);
    } catch(err){
      console.error(err);
      alert('Search failed: '+(err.message || err));
    } finally { hideDfSpinner(); }
  }

  // wire doctor finder events
  $('card-doctors').addEventListener('click', ()=>{ DF.locInput.value=''; dfRenderHistory(); openPopup(DF.modal); setTimeout(()=>{ initMapIfNeeded(); map.invalidateSize(); clearDfMarkers(); },250); DF.resultsEl.innerHTML = '<p class="small-muted">Enter a location and press Search.</p>'; });
  DF.dfClose.addEventListener('click', ()=> closePopup(DF.modal));
  DF.btnReset.addEventListener('click', ()=>{ DF.locInput.value=''; if(map) map.setView([20.5937,78.9629],5); clearDfMarkers(); DF.resultsEl.innerHTML = '<p class="small-muted">Enter a location and press Search.</p>'; });
  DF.btnSearch.addEventListener('click', ()=>{ const q = DF.locInput.value.trim(); if(!q) return alert('Enter a location'); dfSearchFlow(q); });
  DF.btnUseHistory.addEventListener('click', ()=>{ const val = DF.historySelect.value; if(!val) return alert('Choose a history item'); DF.locInput.value = val; });
  dfRenderHistory();

  /************************** Initialization & misc **************************/
  // basic wiring for other cards
  $('open-tracker').addEventListener('click', ()=> { medLoad(); medRenderAll(); $('trackerModal').classList.add('is-visible'); $('trackerModal').setAttribute('aria-hidden','false'); });
  $('close-tracker').addEventListener('click', ()=> { $('trackerModal').classList.remove('is-visible'); $('trackerModal').setAttribute('aria-hidden','true'); });
  $('open-vaccination').addEventListener('click', ()=> { vaccLoad(); vaccRenderAll(); $('vaccinationModal').classList.add('is-visible'); $('vaccinationModal').setAttribute('aria-hidden','false'); });
  $('open-sos').addEventListener('click', ()=> openPopup($('sosModal')));

  // SOS wiring
  $('close-sos').addEventListener('click', ()=> closePopup($('sosModal')));
  $('sos-btn').addEventListener('click', ()=> { if(confirm('Call emergency number 108 now?')) window.location.href = 'tel:108'; });

  // init small modules
  drivesRender(); tipsLoad(); tipsSave(); familyLoad(); familyRender(); statsLoad(); statsRenderAll(); medLoad(); medRenderAll(); vaccLoad(); vaccRenderAll();

  // helper to close all fs/popups via close buttons
  document.querySelectorAll('.popup-close').forEach(btn=>btn.addEventListener('click', ()=> btn.closest('.popup').classList.remove('is-visible')));
  document.querySelectorAll('.fs-close').forEach(btn=>btn.addEventListener('click', ()=> btn.closest('.fullscreen').classList.remove('is-visible')));
  // hide global spinner initially
  hideSpinner();
  </script>
</body>
</html>


